<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0 Transitional//EN">
<html>
<head>
<title>银行卡号生成器</title>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<link rel="icon" href="icon.ico">
<style type="text/css">
body { font-family: Arial, "宋体"; background-color: #F7FAFC; margin: 20px; }
.card { background-color: #FFFFFF; border: 1px solid #CCCCCC; padding: 10px; width: 640px; }
h1 { font-size: 16pt; margin-bottom: 4px; }
label { display: block; margin-top: 8px; }
input, select, button { font-size: 12pt; margin-top: 4px; }
pre { background: #EEE; padding: 6px; white-space: pre-wrap; }
.note { background: #FFFBE6; border: 1px solid #FFD; padding: 6px; margin-top: 8px; }
</style>
</head>
<div class="card">
<h1>银行卡号生成器</h1>
<p>输入卡号前缀（仅数字），可自动推测卡组织可能的总长度，并生成银行卡号。</p>

<label>前缀或 BIN（通常为前2或6位数字）：
<input type="text" id="prefix" onkeyup="updateLengths()">
</label>

<label>检测到的可能总长度：
<select id="lenSel"></select>
</label>

<label>生成数量：
<input type="text" id="count" value="5">
</label>

<br>
<input type="button" value="生成银行卡号" onclick="computeAndShow(false)">
<input type="button" value="清空结果" onclick="clearOut()">

<div id="out" style="margin-top:10px;">
<pre id="details"></pre>
</div>

<div class="note">
技术说明：可生成经过Luhn算法校验的卡号。
</div>
</div>

<script>
// ====== 工具 ======
function safeSub(s, start, len) {
  if (start >= s.length) return "";
  return s.substring(start, start + len);
}

function onlyDigits(s) {
  var r = "", i, c;
  for (i=0; i<s.length; i++) {
    c = s.charAt(i);
    if (c >= '0' && c <= '9') r += c;
  }
  return r;
}

// ====== 前缀检测（已修复）======
function guessLengthsByPrefix(p) {
  var s = onlyDigits(p);
  if (s.length == 0) return [16];

  var f1 = safeSub(s,0,1);
  var f2 = parseInt(safeSub(s,0,2),10);
  var f3 = parseInt(safeSub(s,0,3),10);
  var f4 = parseInt(safeSub(s,0,4),10);
  var f6 = parseInt(safeSub(s,0,6),10);

  if (isNaN(f2)) f2 = -1;
  if (isNaN(f3)) f3 = -1;
  if (isNaN(f4)) f4 = -1;
  if (isNaN(f6)) f6 = -1;

  // Amex
  if (safeSub(s,0,2)=="34" || safeSub(s,0,2)=="37")
    return [15];

  // Diners
  if ((f3>=300 && f3<=305) || safeSub(s,0,2)=="36" || safeSub(s,0,2)=="38" || safeSub(s,0,2)=="39")
    return [14];

  // Visa
  if (f1=="4") return [13,16,19];

  // Mastercard
  if ((f2>=51 && f2<=55) || (f4>=2221 && f4<=2720))
    return [16];

  // Discover
  if (safeSub(s,0,4)=="6011" ||
      safeSub(s,0,2)=="65" ||
      (f3>=644 && f3<=649) ||
      (f6>=622126 && f6<=622925))
    return [16,19];

  // JCB
  if (f4>=3528 && f4<=3589)
    return [16,19];

  // UnionPay
  if (safeSub(s,0,2)=="62" ||
      safeSub(s,0,2)=="81" ||
      safeSub(s,0,2)=="88" ||
      safeSub(s,0,2)=="95")
    return [16,18,19];

  // Maestro
  if (f2>=50 && f2<=69)
    return [16,17,18,19];

  // MIR
  if (f4>=2200 && f4<=2204)
    return [16,19];

  // RuPay
  if (safeSub(s,0,3)=="508" ||
      safeSub(s,0,2)=="60" ||
      safeSub(s,0,2)=="65" ||
      safeSub(s,0,2)=="81" ||
      safeSub(s,0,2)=="82")
    return [16];

  return [16];
}

// ====== Luhn 校验位 ======
function luhnComputeCheckDigit(s) {
  var sum = 0, i, pos, d, v, L = s.length;
  for (i=0; i<L; i++) {
    d = parseInt(s.charAt(L-1-i),10);
    if (isNaN(d)) d = 0;

    pos = i + 2;
    if (pos % 2 == 0) {
      v = d * 2;
      if (v > 9) v -= 9;
      sum += v;
    } else {
      sum += d;
    }
  }
  return (10 - (sum % 10)) % 10;
}

// ====== 随机数字 ======
function randomDigits(n) {
  var s = "", i;
  for (i=0; i<n; i++) s += Math.floor(Math.random()*10);
  return s;
}

// ====== 长度选择更新（彻底修复）======
function updateLengths() {
  var prefix = document.all.prefix.value;
  var lens = guessLengthsByPrefix(prefix);

  var sel = document.all.lenSel;
  sel.options.length = 0;

  var i;
  for (i=0; i<lens.length; i++) {
    sel.options[i] = new Option(lens[i] + " 位", lens[i]);
  }
}

// ====== 生成 ======
function computeAndShow(onlyCheck) {
  var prefix = onlyDigits(document.all.prefix.value);

  updateLengths();  // 确保刷新
  var lensel = document.all.lenSel;
  var totalLen = parseInt(lensel.value,10);

  var n = parseInt(document.all.count.value,10);
  if (isNaN(n) || n<=0) n = 1;
  

  var pre = document.all.details;
  pre.innerText = "";  // 用 innerText 替代 innerHTML 以确保兼容性

  var i;
  for (i=0; i<n; i++) {
    var coreLen = totalLen - prefix.length - 1;
    if (coreLen < 0) {
      pre.innerText = "前缀长度超过总长度。";
      return;
    }

    var core = randomDigits(coreLen);
    var without = prefix + core;
    var chk = luhnComputeCheckDigit(without);

    var line;
    if (onlyCheck)
      line = "校验位 = " + chk;
    else
      line = "卡号 " + (i+1) + ": " + without + chk ;

    pre.innerText += line + "\n";
  }
}

function clearOut() {
  document.all.details.innerText = "";
}

// 初始化一次
updateLengths();
</script>

</body>
</html>
