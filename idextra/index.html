<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>身份证号码解析工具</title>
  <style>
    .invalid { color: red; }
    .valid { color: green; }
    .disbanded { color: red; }
    .unauthorized { color: blue; }
  </style>
</head>
<body>
  <h1>身份证号码解析工具</h1>

  <div>
    <h2>18位身份证号码解析</h2>
    <input type="text" id="idCard18" placeholder="请输入18位身份证号码">
    <button onclick="parse18IdCard()">解析</button>
    <div id="result18"></div>
  </div>

  <div>
    <h2>15位转18位</h2>
    <input type="text" id="idCard15" placeholder="请输入15位身份证号码">
    <select id="yearOption">
      <option value="19">19**年</option>
      <option value="20">20**年</option>
    </select>
    <button onclick="convert15To18()">转换为18位</button>
    <div id="result15"></div>
  </div>

  <div>
    <h2>18位转15位</h2>
    <input type="text" id="idCard18To15" placeholder="请输入18位身份证号码">
    <button onclick="convert18To15()">转换为15位</button>
    <div id="result18To15"></div>
  </div>

  <script>
    let regions = {}; // 存储区域信息

    // 加载 region.txt 文件
    async function loadRegionData() {
      const response = await fetch('region.txt');
      const text = await response.text();

      text.split('\n').forEach(line => {
        line = line.trim(); // 去掉每行前后的空白字符
        if (line) {
          const codeMatch = line.match(/^(\d{2}|\d{4}|\d{6})/);  // 匹配前2位、前4位或前6位
          if (!codeMatch) return;

          const code = codeMatch[0];  // 获取区域的前2位、前4位或前6位代码
          let description = line.replace(code, '').trim(); // 去掉代码部分
          let status = 'normal';

          // 解析撤并或黑区标记
          if (description.startsWith('[') && description.endsWith(']')) {
            description = description.slice(1, -1); // 去掉方括号
            status = 'disbanded';
          } else if (description.endsWith('*')) {
            description = description.slice(0, -1); // 去掉 * 后缀
            status = 'unauthorized';
          }

          // 处理省级
          if (code.length === 2) {
            regions[code] = { name: description, cities: {} };
          }
          // 处理市级
          else if (code.length === 4) {
            const provinceCode = code.slice(0, 2);
            if (regions[provinceCode]) {
              regions[provinceCode].cities[code] = { name: description, districts: {} };
            }
          }
          // 处理区级
          else if (code.length === 6) {
            const provinceCode = code.slice(0, 2);
            const cityCode = code.slice(0, 4);
            if (regions[provinceCode] && regions[provinceCode].cities[cityCode]) {
              regions[provinceCode].cities[cityCode].districts[code] = { name: description, status };
            }
          }
        }
      });
    }

    // 获取身份证的签发地
    function getRegion(code) {
      const provinceCode = code.slice(0, 2);
      const cityCode = code.slice(0, 4);
      const districtCode = code.slice(0, 6);

      if (regions[provinceCode]) {
        const provinceName = regions[provinceCode].name;
        let region = `${provinceName}`;
        if (regions[provinceCode].cities[cityCode]) {
          const cityName = regions[provinceCode].cities[cityCode].name;
          region += ` ${cityName}`;
          if (regions[provinceCode].cities[cityCode].districts[districtCode]) {
            const district = regions[provinceCode].cities[cityCode].districts[districtCode];
            region += ` ${district.name}`;
            if (district.status === 'disbanded') {
              region += ' <span class="disbanded">(该地区已被撤并)</span>';
            } else if (district.status === 'unauthorized') {
              region += ' <span class="unauthorized">(该地区事实存在，但属于国务院不承认的黑区)</span>';
            }
          }
        }
        return region;
      }
      return '无法识别签发地';
    }

    // 解析18位身份证号码
    function parse18IdCard() {
      const idCard18 = document.getElementById('idCard18').value.trim();
      const resultDiv = document.getElementById('result18');

      if (idCard18.length === 18) {
        const regionCode = idCard18.slice(0, 6);
        resultDiv.innerHTML = `签发地：${getRegion(regionCode)}<br>`;
        resultDiv.innerHTML += `出生日期：${idCard18.slice(6, 10)}-${idCard18.slice(10, 12)}-${idCard18.slice(12, 14)}<br>`;
        resultDiv.innerHTML += `性别：${parseInt(idCard18.charAt(16)) % 2 === 0 ? '女' : '男'}<br>`;

        // 校验身份证号有效性
        if (isValidIdCard(idCard18)) {
          resultDiv.innerHTML += `<span class="valid">该身份证号有效</span>`;
        } else {
          resultDiv.innerHTML += `<span class="invalid">该身份证号无效</span>`;
        }
      } else {
        resultDiv.innerHTML = '请输入有效的18位身份证号码';
      }
    }

    // 校验身份证号码是否有效
    function isValidIdCard(idCard) {
      const weights = [7, 9, 10, 5, 8, 4, 2, 1, 6, 3, 7, 9, 10, 5, 8, 4, 2]; // 校验权重
      const verifyCode = ['1', '0', 'X', '9', '8', '7', '6', '5', '4', '3', '2']; // 校验码字符

      let sum = 0;
      for (let i = 0; i < 17; i++) {
        sum += parseInt(idCard.charAt(i)) * weights[i];
      }
      const mod = sum % 11;
      const checkChar = verifyCode[mod];
      return idCard.charAt(17).toUpperCase() === checkChar;
    }

    // 页面加载时加载区域数据
    loadRegionData();
  </script>
</body>
</html>
