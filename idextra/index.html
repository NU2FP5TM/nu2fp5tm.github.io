<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>身份证号解析工具</title>
  <style>
    .invalid { color: red; }
    .valid { color: green; }
    .disbanded { color: red; }
    .unauthorized { color: blue; }
  </style>
</head>
<body>
  <h1>身份证号码解析工具</h1>
  
  <!-- 15位身份证输入框 -->
  <div>
    <h2>15位身份证号码解析</h2>
    <input type="text" id="idCard15" placeholder="请输入15位身份证号码">
    <button onclick="convert15To18()">转换为18位</button>
    <div id="result15"></div>
  </div>

  <!-- 17位身份证输入框 -->
  <div>
    <h2>17位身份证号码解析</h2>
    <input type="text" id="idCard17" placeholder="请输入17位身份证号码">
    <button onclick="convert17To18()">计算校验码并转换为18位</button>
    <div id="result17"></div>
  </div>

  <!-- 18位身份证输入框 -->
  <div>
    <h2>18位身份证号码解析</h2>
    <input type="text" id="idCard18" placeholder="请输入18位身份证号码">
    <button onclick="parse18IdCard()">解析身份证</button>
    <div id="result18"></div>
  </div>

  <script>
    let regions = {};  // 存储区域信息

    // 加载 region.txt 文件
    async function loadRegionData() {
      const response = await fetch('region.txt');
      const text = await response.text();

      text.split('\n').forEach(line => {
        line = line.trim();  // 去掉每行前后的空白字符
        if (line) {
          const codeMatch = line.match(/^(\d{2}|\d{6})/);  // 匹配前2位或前6位
          if (!codeMatch) return;

          const code = codeMatch[0];  // 获取区域的前2位或前6位代码
          let description = line.replace(code, '').trim(); // 去掉代码部分
          let status = 'normal';

          // 解析撤并或黑区标记
          if (description.startsWith('[') && description.endsWith(']')) {
            description = description.slice(1, -1); // 去掉方括号
            status = 'disbanded';
          } else if (description.endsWith('*')) {
            description = description.slice(0, -1); // 去掉 * 后缀
            status = 'unauthorized';
          }

          // 处理省级
          if (code.length === 2) {
            regions[code] = { name: description, cities: {} };
          }
          // 处理市级
          else if (code.length === 4) {
            const provinceCode = code.slice(0, 2);
            if (regions[provinceCode]) {
              regions[provinceCode].cities[code] = { name: description, districts: {} };
            }
          }
          // 处理区级
          else if (code.length === 6) {
            const provinceCode = code.slice(0, 2);
            const cityCode = code.slice(0, 4);
            if (regions[provinceCode] && regions[provinceCode].cities[cityCode]) {
              regions[provinceCode].cities[cityCode].districts[code] = { name: description, status };
            }
          }
        }
      });
    }

    // 获取身份证的签发地
    function getRegion(code) {
      const provinceCode = code.slice(0, 2);
      const cityCode = code.slice(0, 4);
      const districtCode = code.slice(0, 6);

      // 先根据省、市、区逐步匹配
      if (regions[provinceCode]) {
        const provinceName = regions[provinceCode].name;
        if (regions[provinceCode].cities[cityCode]) {
          const cityName = regions[provinceCode].cities[cityCode].name;
          if (regions[provinceCode].cities[cityCode].districts[districtCode]) {
            const district = regions[provinceCode].cities[cityCode].districts[districtCode];
            let region = `${provinceName} ${cityName} ${district.name}`;
            if (district.status === 'disbanded') {
              region += ' <span class="disbanded">(该地区已被撤并)</span>';
            } else if (district.status === 'unauthorized') {
              region += ' <span class="unauthorized">(该地区事实存在，但属于国务院不承认的黑区)</span>';
            }
            return region;
          } else {
            return `${provinceName} ${cityName}`;
          }
        }
      }
      return '无法识别签发地';
    }

    // 校验18位身份证号码是否有效
    function isValidIdCard(idCard) {
      const factors = [7, 9, 10, 5, 8, 4, 2, 1, 6, 3, 7, 9, 10, 5, 8, 4, 2];
      const checkCode = ['1', '0', 'X', '9', '8', '7', '6', '5', '4', '3', '2'];
      let sum = 0;

      for (let i = 0; i < 17; i++) {
        sum += parseInt(idCard.charAt(i)) * factors[i];
      }
      const checkDigit = checkCode[sum % 11];
      return idCard.charAt(17).toUpperCase() === checkDigit;
    }

    // 15位转18位身份证号码
    function convert15To18(idCard) {
      const year = '19' + idCard.slice(6, 8);
      const month = idCard.slice(8, 10);
      const day = idCard.slice(10, 12);
      const regionCode = idCard.slice(0, 6);
      const sequence = idCard.slice(12, 15);

      const tempId = `${regionCode}${year}${month}${day}${sequence}`;
      const checkCode = calculateCheckCode(tempId);
      return `${tempId}${checkCode}`;
    }

    // 17位转18位身份证号码（计算校验码）
    function convert17To18(idCard) {
      if (idCard.length === 17) {
        const regionCode = idCard.slice(0, 6);
        const year = idCard.slice(6, 10);
        const month = idCard.slice(10, 12);
        const day = idCard.slice(12, 14);
        const sequence = idCard.slice(14, 17);

        const tempId = `${regionCode}${year}${month}${day}${sequence}`;
        const checkCode = calculateCheckCode(tempId);
        const fullId = `${tempId}${checkCode}`;

        document.getElementById('result17').innerHTML = `计算出的18位身份证号为：${fullId}`;
      }
    }

    // 18位转15位身份证号码
    function convert18To15(idCard) {
      return idCard.slice(0, 6) + idCard.slice(8, 17);
    }

    // 计算身份证号的校验码
    function calculateCheckCode(idCard) {
      const factors = [7, 9, 10, 5, 8, 4, 2, 1, 6, 3, 7, 9, 10, 5, 8, 4, 2];
      const checkCode = ['1', '0', 'X', '9', '8', '7', '6', '5', '4', '3', '2'];
      let sum = 0;

      for (let i = 0; i < 17; i++) {
        sum += parseInt(idCard.charAt(i)) * factors[i];
      }
      return checkCode[sum % 11];
    }

    // 解析18位身份证号码
    function parse18IdCard() {
      const idCard18 = document.getElementById('idCard18').value.trim();
      const resultDiv = document.getElementById('result18');

      if (idCard18.length === 18) {
        const regionCode = idCard18.slice(0, 6);
        resultDiv.innerHTML = `签发地：${getRegion(regionCode)}<br>`;
        resultDiv.innerHTML += `出生日期：${idCard18.slice(6, 10)}-${idCard18.slice(10, 12)}-${idCard18.slice(12, 14)}<br>`;
        resultDiv.innerHTML += `性别：${parseInt(idCard18.charAt(16)) % 2 === 0 ? '女' : '男'}<br>`;

        if (isValidIdCard(idCard18)) {
          resultDiv.innerHTML += `<span class="valid">该身份证号有效</span>`;
        } else {
          resultDiv.innerHTML += `<span class="invalid">该身份证号无效</span>`;
        }
      } else {
        resultDiv.innerHTML = '请输入有效的18位身份证号码';
      }
    }

    // 页面加载时初始化
    loadRegionData();
  </script>
</body>
</html>
