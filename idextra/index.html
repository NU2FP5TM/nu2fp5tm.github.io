<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>身份证号码解析</title>
  <style>
    .invalid { color: red; }
    .valid { color: green; }
    .disbanded { color: red; }
    .unauthorized { color: blue; }
  </style>
</head>
<body>
  <h1>身份证号码解析</h1>
  <label for="idCardInput">输入身份证号：</label>
  <input type="text" id="idCardInput" maxlength="18" placeholder="请输入15或18位身份证号码">
  <button onclick="analyzeIdCard()">解析</button>

  <div id="result"></div>

  <!-- 18位转15位输入框 -->
  <h2>18位转15位</h2>
  <input type="text" id="idCard18To15Input" maxlength="18" placeholder="请输入18位身份证号码">
  <button onclick="convertTo15()">转换为15位</button>
  <div id="convertResult"></div>

  <script>
    document.getElementById('idCardInput').addEventListener('keypress', function (e) {
      if (e.key === 'Enter') {
        analyzeIdCard();
      }
    });

    async function loadRegionData() {
      const response = await fetch('region.txt');
      const text = await response.text();
      const regions = {};
      text.split('\n').forEach(line => {
        line = line.trim();
        if (line) {
          const codeMatch = line.match(/^(\d{6})/);
          if (!codeMatch) return;
          const code = codeMatch[0];
          
          let description = line.replace(code, '').trim();
          let status = 'normal';
          
          if (description.startsWith('[') && description.endsWith(']')) {
            description = description.slice(1, -1);
            status = 'disbanded';
          } else if (description.endsWith('*')) {
            description = description.slice(0, -1);
            status = 'unauthorized';
          }

          regions[code] = { name: description, status };
        }
      });
      return regions;
    }

    function calculateChecksum(id) {
      const weights = [7, 9, 10, 5, 8, 4, 2, 1, 6, 3, 7, 9, 10, 5, 8, 4, 2];
      const checksumChars = '10X98765432';
      let sum = 0;
      for (let i = 0; i < 17; i++) {
        sum += parseInt(id[i]) * weights[i];
      }
      return checksumChars[sum % 11];
    }

    async function analyzeIdCard() {
      const idCardInput = document.getElementById('idCardInput').value.trim();
      const resultDiv = document.getElementById('result');
      resultDiv.innerHTML = '';

      if (!/^\d{15}$|^\d{17}(\d|X)?$/.test(idCardInput)) {
        resultDiv.innerHTML = '<p class="invalid">请输入有效的15位或18位身份证号码</p>';
        return;
      }

      const regions = await loadRegionData();

      let idCard = idCardInput;
      if (idCard.length === 15) {
        // 15位身份证号码补全
        const century = confirm('请选择生日的世纪：按“确定”选择19**年，按“取消”选择20**年') ? '19' : '20';
        idCard = idCard.slice(0, 6) + century + idCard.slice(6);
        const checksum = calculateChecksum(idCard);
        idCard += checksum;
        resultDiv.innerHTML = `<p>补全后的18位身份证号码是：${idCard}</p>`;
      }

      const regionCode = idCard.substring(0, 6);
      const birthday = idCard.substring(6, 14);
      const genderCode = idCard[16];
      const checksum = idCard[17];

      let regionInfo = regions[regionCode] || { name: '未知地区', status: 'unknown' };
      let regionDisplay = regionInfo.name;
      if (regionInfo.status === 'disbanded') {
        regionDisplay += ' <span class="disbanded">（该地区已被撤并）</span>';
      } else if (regionInfo.status === 'unauthorized') {
        regionDisplay += ' <span class="unauthorized">（该地区事实存在，但属于国务院不承认的黑区）</span>';
      }

      const birthDate = `${birthday.slice(0, 4)}-${birthday.slice(4, 6)}-${birthday.slice(6, 8)}`;
      const gender = genderCode % 2 === 1 ? '男' : '女';

      const isValid = checksum.toUpperCase() === calculateChecksum(idCard);
      resultDiv.innerHTML += `<p class="${isValid ? 'valid' : 'invalid'}">该身份证号码${isValid ? '有效' : '无效'}</p>`;

      resultDiv.innerHTML += `
        <p>签发地：${regionDisplay}</p>
        <p>出生日期：${birthDate}</p>
        <p>性别：${gender}</p>
      `;
    }

    function convertTo15() {
      const idCard18To15Input = document.getElementById('idCard18To15Input').value.trim();
      const convertResultDiv = document.getElementById('convertResult');
      convertResultDiv.innerHTML = '';

      if (!/^\d{17}(\d|X)$/.test(idCard18To15Input)) {
        convertResultDiv.innerHTML = '<p class="invalid">请输入有效的18位身份证号码</p>';
        return;
      }

      const idCard15 = idCard18To15Input.slice(0, 6) + idCard18To15Input.slice(8, 17);
      convertResultDiv.innerHTML = `<p>转换后的15位身份证号码是：${idCard15}</p>`;
    }
  </script>
</body>
</html>

